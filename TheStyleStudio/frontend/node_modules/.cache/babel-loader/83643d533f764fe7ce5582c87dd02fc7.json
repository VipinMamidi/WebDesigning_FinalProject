{"ast":null,"code":"import _objectSpread from\"/Users/riddhibhatti/Webdesign/WebDFinalProject/WebDesigning_FinalProject/TheStyleStudio/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _asyncToGenerator from\"/Users/riddhibhatti/Webdesign/WebDFinalProject/WebDesigning_FinalProject/TheStyleStudio/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/Users/riddhibhatti/Webdesign/WebDFinalProject/WebDesigning_FinalProject/TheStyleStudio/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/Users/riddhibhatti/Webdesign/WebDFinalProject/WebDesigning_FinalProject/TheStyleStudio/node_modules/@babel/runtime/regenerator/index.js\";import React,{useState,useEffect}from\"react\";import{useDispatch,useSelector}from\"react-redux\";import{Row,Col,ListGroup,Image,Card,Button}from\"react-bootstrap\";import{Link}from\"react-router-dom\";import{PayPalButton}from\"react-paypal-button-v2\";// for paypal payments\nimport axios from\"axios\";import Message from\"../components/Message\";import Loader from\"../components/Loader\";import{getOrderDetails,payOrder,deliverOrder}from\"../actions/orderActions\";import{ORDER_PAY_RESET,ORDER_DELIVER_RESET}from\"../constants/orderConstants\";import{savePaymentMethod}from\"../actions/cartActions\";import{Elements}from\"@stripe/react-stripe-js\";import{loadStripe}from\"@stripe/stripe-js\";import{refreshLogin}from\"../actions/userActions\";import CheckoutForm from\"../components/CheckoutForm\";//stripe checkout form\nimport getDateString from\"../utils/getDateString\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var OrderPage=function OrderPage(_ref){var match=_ref.match,history=_ref.history;// load stripe\nvar stripePromise=loadStripe(process.env.REACT_APP_STRIPE_PUBLISHABLE_KEY);// for paypal payment\nvar _useState=useState(false),_useState2=_slicedToArray(_useState,2),SDKReady=_useState2[0],setSDKReady=_useState2[1];var dispatch=useDispatch();var orderID=match.params.id;var orderDetails=useSelector(function(state){return state.orderDetails;});var loading=orderDetails.loading,order=orderDetails.order,error=orderDetails.error;var orderPay=useSelector(function(state){return state.orderPay;});var loadingPay=orderPay.loading,successPay=orderPay.success;var orderDeliver=useSelector(function(state){return state.orderDeliver;});var loadingDeliver=orderDeliver.loading,successDeliver=orderDeliver.success;var userLogin=useSelector(function(state){return state.userLogin;});var userInfo=userLogin.userInfo;var userDetails=useSelector(function(state){return state.userDetails;});var userLoginError=userDetails.error;// get new access tokens using the refresh token, is user details throws an error\nuseEffect(function(){if(userLoginError&&userInfo&&!userInfo.isSocialLogin){var user=JSON.parse(localStorage.getItem(\"userInfo\"));user&&dispatch(refreshLogin(user.email));}},[userLoginError,dispatch,userInfo]);// set order to paid or delivered, and fetch updated orders\nuseEffect(function(){if(!order||order._id!==orderID||successPay||successDeliver){if(successPay)dispatch({type:ORDER_PAY_RESET});if(successDeliver)dispatch({type:ORDER_DELIVER_RESET});dispatch(getOrderDetails(orderID));}},[order,orderID,dispatch,successPay,successDeliver]);// add the script required for paypal payments dynamically, to avoid possible attacks\nuseEffect(function(){var addScript=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var config,_yield$axios$get,clientID,script;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:config=userInfo.isSocialLogin?{headers:{Authorization:\"SocialLogin \".concat(userInfo.id)}}:{headers:{Authorization:\"Bearer \".concat(userInfo.accessToken)}};_context.next=3;return axios.get(\"/api/config/paypal\",config);case 3:_yield$axios$get=_context.sent;clientID=_yield$axios$get.data;// add the script\nscript=document.createElement(\"script\");script.async=true;script.type=\"text/javascript\";script.src=\"https://www.paypal.com/sdk/js?client-id=\".concat(clientID,\"&currency=USD&disable-funding=credit,card\");script.onload=function(){return setSDKReady(true);};document.body.appendChild(script);case 11:case\"end\":return _context.stop();}}},_callee);}));return function addScript(){return _ref2.apply(this,arguments);};}();if(!userInfo)history.push(\"/login\");// if not loggein in\nif(!SDKReady)addScript();},[userInfo,SDKReady,history]);// save the payment mthod as paypal\nvar successPaymentHandler=function successPaymentHandler(paymentResult){dispatch(savePaymentMethod(\"PayPal\"));dispatch(payOrder(orderID,_objectSpread(_objectSpread({},paymentResult),{},{paymentMode:\"paypal\"})));};// set order as delivered\nvar successDeliveryHandler=function successDeliveryHandler(){dispatch(deliverOrder(orderID));};return loading?/*#__PURE__*/_jsx(Loader,{}):error?/*#__PURE__*/_jsx(Message,{dismissible:true,variant:\"danger\",duration:10,children:error}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"h2\",{children:[\"Order \",orderID]}),/*#__PURE__*/_jsx(Row,{children:loading?/*#__PURE__*/_jsx(Loader,{}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Col,{md:8,children:/*#__PURE__*/_jsxs(ListGroup,{variant:\"flush\",children:[/*#__PURE__*/_jsxs(ListGroup.Item,{children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Shipping\"}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Name: \"}),order.user.name]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Email: \"}),/*#__PURE__*/_jsx(\"a\",{href:\"mailto:\".concat(order.user.email),children:order.user.email})]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Address: \"}),\" \",order.shippingAddress.address,\",\",\" \",order.shippingAddress.city,\"-\",order.shippingAddress.postalCode,\",\",\" \",order.shippingAddress.country]}),/*#__PURE__*/_jsx(\"div\",{children:order.isDelivered?/*#__PURE__*/_jsxs(Message,{variant:\"success\",children:[\"Delivered at: \",getDateString(order.deliveredAt)]}):/*#__PURE__*/_jsx(Message,{variant:\"danger\",children:\"Not Delivered\"})})]}),/*#__PURE__*/_jsxs(ListGroup.Item,{children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Payment Method\"}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Method: \"}),\" \",order.paymentMethod]}),/*#__PURE__*/_jsx(\"div\",{children:order.isPaid?/*#__PURE__*/_jsxs(Message,{variant:\"success\",children:[\"Paid at: \",getDateString(order.paidAt)]}):/*#__PURE__*/_jsx(Message,{variant:\"danger\",children:\"Not Paid\"})})]}),/*#__PURE__*/_jsxs(ListGroup.Item,{children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Cart Items\"}),order.orderItems.length!==0?/*#__PURE__*/_jsxs(ListGroup,{variant:\"flush\",children:[/*#__PURE__*/_jsx(\"div\",{style:{background:\"red\"}}),order.orderItems.map(function(item,idx){return/*#__PURE__*/_jsx(ListGroup.Item,{children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{md:2,children:/*#__PURE__*/_jsx(Image,{className:\"product-image\",src:item.image,alt:item.name,fluid:true,rounded:true})}),/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(Link,{to:\"/product/\".concat(item.product),children:item.name})}),/*#__PURE__*/_jsxs(Col,{md:4,children:[item.qty,\" x \",item.price,\" =\",\" \",(item.qty*item.price).toLocaleString(\"en-US\",{maximumFractionDigits:2,style:\"currency\",currency:\"USD\"})]})]})},idx);})]}):/*#__PURE__*/_jsx(Message,{children:\"No order\"})]})]})}),/*#__PURE__*/_jsx(Col,{md:4,children:/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsxs(ListGroup,{variant:\"flush\",children:[/*#__PURE__*/_jsx(ListGroup.Item,{children:/*#__PURE__*/_jsx(\"h2\",{className:\"text-center\",children:\"Order Summary\"})}),error&&/*#__PURE__*/_jsx(ListGroup.Item,{children:/*#__PURE__*/_jsx(Message,{dismissible:true,variant:\"danger\",duration:10,children:error})}),/*#__PURE__*/_jsx(ListGroup.Item,{children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(\"strong\",{children:\"Subtotal\"})}),/*#__PURE__*/_jsx(Col,{children:order.itemsPrice.toLocaleString(\"en-US\",{maximumFractionDigits:2,style:\"currency\",currency:\"USD\"})})]})}),/*#__PURE__*/_jsx(ListGroup.Item,{children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(\"strong\",{children:\"Shipping\"})}),/*#__PURE__*/_jsx(Col,{children:order.shippingPrice.toLocaleString(\"en-US\",{maximumFractionDigits:2,style:\"currency\",currency:\"USD\"})})]})}),/*#__PURE__*/_jsx(ListGroup.Item,{children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(\"strong\",{children:\"Tax\"})}),/*#__PURE__*/_jsx(Col,{children:order.taxPrice.toLocaleString(\"en-US\",{maximumFractionDigits:2,style:\"currency\",currency:\"USD\"})})]})}),/*#__PURE__*/_jsx(ListGroup.Item,{children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(\"strong\",{children:\"Total\"})}),/*#__PURE__*/_jsx(Col,{children:order.totalPrice.toLocaleString(\"en-US\",{maximumFractionDigits:2,style:\"currency\",currency:\"USD\"})})]})}),!order.isPaid&&/*#__PURE__*/_jsx(_Fragment,{children:order.paymentMethod===\"PayPal\"?/*#__PURE__*/_jsxs(ListGroup.Item,{children:[loadingPay&&/*#__PURE__*/_jsx(Loader,{}),!SDKReady?/*#__PURE__*/_jsx(Loader,{}):/*#__PURE__*/_jsx(PayPalButton,{style:{shape:\"rect\",color:\"gold\",layout:\"vertical\",label:\"pay\"},currency:\"USD\",amount:Number(order.totalPrice/1).toFixed(2),onSuccess:successPaymentHandler})]}):/*#__PURE__*/_jsxs(ListGroup.Item,{children:[loadingPay&&/*#__PURE__*/_jsx(Loader,{}),/*#__PURE__*/_jsx(Elements,{stripe:stripePromise,children:/*#__PURE__*/_jsx(CheckoutForm,{price:order.totalPrice*100,orderID:orderID})})]})}),userInfo&&userInfo.isAdmin&&order.isPaid&&!order.isDelivered&&/*#__PURE__*/_jsxs(ListGroup.Item,{children:[loadingDeliver&&/*#__PURE__*/_jsx(Loader,{}),/*#__PURE__*/_jsx(\"div\",{className:\"d-grid\",children:/*#__PURE__*/_jsx(Button,{type:\"button\",variant:\"info\",size:\"lg\",onClick:successDeliveryHandler,children:\"Mark as Delivered\"})})]})]})})})]})})]});};export default OrderPage;","map":{"version":3,"sources":["/Users/riddhibhatti/Webdesign/WebDFinalProject/WebDesigning_FinalProject/TheStyleStudio/frontend/src/pages/OrderPage.js"],"names":["React","useState","useEffect","useDispatch","useSelector","Row","Col","ListGroup","Image","Card","Button","Link","PayPalButton","axios","Message","Loader","getOrderDetails","payOrder","deliverOrder","ORDER_PAY_RESET","ORDER_DELIVER_RESET","savePaymentMethod","Elements","loadStripe","refreshLogin","CheckoutForm","getDateString","OrderPage","match","history","stripePromise","process","env","REACT_APP_STRIPE_PUBLISHABLE_KEY","SDKReady","setSDKReady","dispatch","orderID","params","id","orderDetails","state","loading","order","error","orderPay","loadingPay","successPay","success","orderDeliver","loadingDeliver","successDeliver","userLogin","userInfo","userDetails","userLoginError","isSocialLogin","user","JSON","parse","localStorage","getItem","email","_id","type","addScript","config","headers","Authorization","accessToken","get","clientID","data","script","document","createElement","async","src","onload","body","appendChild","push","successPaymentHandler","paymentResult","paymentMode","successDeliveryHandler","name","shippingAddress","address","city","postalCode","country","isDelivered","deliveredAt","paymentMethod","isPaid","paidAt","orderItems","length","background","map","item","idx","image","product","qty","price","toLocaleString","maximumFractionDigits","style","currency","itemsPrice","shippingPrice","taxPrice","totalPrice","shape","color","layout","label","Number","toFixed","isAdmin"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from \"react\";\r\nimport { useDispatch, useSelector } from \"react-redux\";\r\nimport { Row, Col, ListGroup, Image, Card, Button } from \"react-bootstrap\";\r\nimport { Link } from \"react-router-dom\";\r\nimport { PayPalButton } from \"react-paypal-button-v2\"; // for paypal payments\r\nimport axios from \"axios\";\r\nimport Message from \"../components/Message\";\r\nimport Loader from \"../components/Loader\";\r\nimport {\r\n  getOrderDetails,\r\n  payOrder,\r\n  deliverOrder,\r\n} from \"../actions/orderActions\";\r\nimport {\r\n  ORDER_PAY_RESET,\r\n  ORDER_DELIVER_RESET,\r\n} from \"../constants/orderConstants\";\r\nimport { savePaymentMethod } from \"../actions/cartActions\";\r\nimport { Elements } from \"@stripe/react-stripe-js\";\r\nimport { loadStripe } from \"@stripe/stripe-js\";\r\nimport { refreshLogin } from \"../actions/userActions\";\r\nimport CheckoutForm from \"../components/CheckoutForm\"; //stripe checkout form\r\nimport getDateString from \"../utils/getDateString\";\r\n\r\nconst OrderPage = ({ match, history }) => {\r\n  // load stripe\r\n  const stripePromise = loadStripe(\r\n    process.env.REACT_APP_STRIPE_PUBLISHABLE_KEY\r\n  );\r\n  // for paypal payment\r\n  const [SDKReady, setSDKReady] = useState(false);\r\n  const dispatch = useDispatch();\r\n  const orderID = match.params.id;\r\n\r\n  const orderDetails = useSelector((state) => state.orderDetails);\r\n  const { loading, order, error } = orderDetails;\r\n\r\n  const orderPay = useSelector((state) => state.orderPay);\r\n  const { loading: loadingPay, success: successPay } = orderPay;\r\n\r\n  const orderDeliver = useSelector((state) => state.orderDeliver);\r\n  const { loading: loadingDeliver, success: successDeliver } = orderDeliver;\r\n\r\n  const userLogin = useSelector((state) => state.userLogin);\r\n  const { userInfo } = userLogin;\r\n\r\n  const userDetails = useSelector((state) => state.userDetails);\r\n  const { error: userLoginError } = userDetails;\r\n\r\n  // get new access tokens using the refresh token, is user details throws an error\r\n  useEffect(() => {\r\n    if (userLoginError && userInfo && !userInfo.isSocialLogin) {\r\n      const user = JSON.parse(localStorage.getItem(\"userInfo\"));\r\n      user && dispatch(refreshLogin(user.email));\r\n    }\r\n  }, [userLoginError, dispatch, userInfo]);\r\n\r\n  // set order to paid or delivered, and fetch updated orders\r\n  useEffect(() => {\r\n    if (!order || order._id !== orderID || successPay || successDeliver) {\r\n      if (successPay) dispatch({ type: ORDER_PAY_RESET });\r\n      if (successDeliver) dispatch({ type: ORDER_DELIVER_RESET });\r\n      dispatch(getOrderDetails(orderID));\r\n    }\r\n  }, [order, orderID, dispatch, successPay, successDeliver]);\r\n\r\n  // add the script required for paypal payments dynamically, to avoid possible attacks\r\n  useEffect(() => {\r\n    const addScript = async () => {\r\n      const config = userInfo.isSocialLogin\r\n        ? {\r\n            headers: {\r\n              Authorization: `SocialLogin ${userInfo.id}`,\r\n            },\r\n          }\r\n        : {\r\n            headers: {\r\n              Authorization: `Bearer ${userInfo.accessToken}`,\r\n            },\r\n          };\r\n      const { data: clientID } = await axios.get(\"/api/config/paypal\", config);\r\n      // add the script\r\n      const script = document.createElement(\"script\");\r\n      script.async = true;\r\n      script.type = \"text/javascript\";\r\n      script.src = `https://www.paypal.com/sdk/js?client-id=${clientID}&currency=USD&disable-funding=credit,card`;\r\n      script.onload = () => setSDKReady(true);\r\n      document.body.appendChild(script);\r\n    };\r\n    if (!userInfo) history.push(\"/login\"); // if not loggein in\r\n    if (!SDKReady) addScript();\r\n  }, [userInfo, SDKReady, history]);\r\n\r\n  // save the payment mthod as paypal\r\n  const successPaymentHandler = (paymentResult) => {\r\n    dispatch(savePaymentMethod(\"PayPal\"));\r\n    dispatch(payOrder(orderID, { ...paymentResult, paymentMode: \"paypal\" }));\r\n  };\r\n\r\n  // set order as delivered\r\n  const successDeliveryHandler = () => {\r\n    dispatch(deliverOrder(orderID));\r\n  };\r\n\r\n  return loading ? (\r\n    <Loader />\r\n  ) : error ? (\r\n    <Message dismissible variant=\"danger\" duration={10}>\r\n      {error}\r\n    </Message>\r\n  ) : (\r\n    <>\r\n      <h2>Order {orderID}</h2>\r\n      <Row>\r\n        {loading ? (\r\n          <Loader />\r\n        ) : (\r\n          <>\r\n            <Col md={8}>\r\n              <ListGroup variant=\"flush\">\r\n                <ListGroup.Item>\r\n                  <h2>Shipping</h2>\r\n                  <p>\r\n                    <strong>Name: </strong>\r\n                    {order.user.name}\r\n                  </p>\r\n                  <p>\r\n                    <strong>Email: </strong>\r\n                    <a href={`mailto:${order.user.email}`}>\r\n                      {order.user.email}\r\n                    </a>\r\n                  </p>\r\n                  <p>\r\n                    <strong>Address: </strong> {order.shippingAddress.address},{\" \"}\r\n                    {order.shippingAddress.city}-\r\n                    {order.shippingAddress.postalCode},{\" \"}\r\n                    {order.shippingAddress.country}\r\n                  </p>\r\n                  <div>\r\n                    {order.isDelivered ? (\r\n                      <Message variant=\"success\">\r\n                        Delivered at: {getDateString(order.deliveredAt)}\r\n                      </Message>\r\n                    ) : (\r\n                      <Message variant=\"danger\">Not Delivered</Message>\r\n                    )}\r\n                  </div>\r\n                </ListGroup.Item>\r\n                <ListGroup.Item>\r\n                  <h2>Payment Method</h2>\r\n                  <p>\r\n                    <strong>Method: </strong> {order.paymentMethod}\r\n                  </p>\r\n                  <div>\r\n                    {order.isPaid ? (\r\n                      <Message variant=\"success\">\r\n                        Paid at: {getDateString(order.paidAt)}\r\n                      </Message>\r\n                    ) : (\r\n                      <Message variant=\"danger\">Not Paid</Message>\r\n                    )}\r\n                  </div>\r\n                </ListGroup.Item>\r\n                <ListGroup.Item>\r\n                  <h2>Cart Items</h2>\r\n                  {order.orderItems.length !== 0 ? (\r\n                    <ListGroup variant=\"flush\">\r\n                      <div\r\n                        style={{\r\n                          background: \"red\",\r\n                        }}\r\n                      ></div>\r\n                      {order.orderItems.map((item, idx) => (\r\n                        <ListGroup.Item key={idx}>\r\n                          <Row>\r\n                            <Col md={2}>\r\n                              <Image\r\n                                className=\"product-image\"\r\n                                src={item.image}\r\n                                alt={item.name}\r\n                                fluid\r\n                                rounded\r\n                              />\r\n                            </Col>\r\n                            <Col>\r\n                              <Link to={`/product/${item.product}`}>\r\n                                {item.name}\r\n                              </Link>\r\n                            </Col>\r\n                            <Col md={4}>\r\n                              {item.qty} x {item.price} ={\" \"}\r\n                              {(item.qty * item.price).toLocaleString(\"en-US\", {\r\n                                maximumFractionDigits: 2,\r\n                                style: \"currency\",\r\n                                currency: \"USD\",\r\n                              })}\r\n                            </Col>\r\n                          </Row>\r\n                        </ListGroup.Item>\r\n                      ))}\r\n                    </ListGroup>\r\n                  ) : (\r\n                    <Message>No order</Message>\r\n                  )}\r\n                </ListGroup.Item>\r\n              </ListGroup>\r\n            </Col>\r\n            <Col md={4}>\r\n              <Card>\r\n                <ListGroup variant=\"flush\">\r\n                  <ListGroup.Item>\r\n                    <h2 className=\"text-center\">Order Summary</h2>\r\n                  </ListGroup.Item>\r\n                  {error && (\r\n                    <ListGroup.Item>\r\n                      <Message dismissible variant=\"danger\" duration={10}>\r\n                        {error}\r\n                      </Message>\r\n                    </ListGroup.Item>\r\n                  )}\r\n                  <ListGroup.Item>\r\n                    <Row>\r\n                      <Col>\r\n                        <strong>Subtotal</strong>\r\n                      </Col>\r\n                      <Col>\r\n                        {order.itemsPrice.toLocaleString(\"en-US\", {\r\n                          maximumFractionDigits: 2,\r\n                          style: \"currency\",\r\n                          currency: \"USD\",\r\n                        })}\r\n                      </Col>\r\n                    </Row>\r\n                  </ListGroup.Item>\r\n                  <ListGroup.Item>\r\n                    <Row>\r\n                      <Col>\r\n                        <strong>Shipping</strong>\r\n                      </Col>\r\n                      <Col>\r\n                        {order.shippingPrice.toLocaleString(\"en-US\", {\r\n                          maximumFractionDigits: 2,\r\n                          style: \"currency\",\r\n                          currency: \"USD\",\r\n                        })}\r\n                      </Col>\r\n                    </Row>\r\n                  </ListGroup.Item>\r\n                  <ListGroup.Item>\r\n                    <Row>\r\n                      <Col>\r\n                        <strong>Tax</strong>\r\n                      </Col>\r\n                      <Col>\r\n                        {order.taxPrice.toLocaleString(\"en-US\", {\r\n                          maximumFractionDigits: 2,\r\n                          style: \"currency\",\r\n                          currency: \"USD\",\r\n                        })}\r\n                      </Col>\r\n                    </Row>\r\n                  </ListGroup.Item>\r\n                  <ListGroup.Item>\r\n                    <Row>\r\n                      <Col>\r\n                        <strong>Total</strong>\r\n                      </Col>\r\n                      <Col>\r\n                        {order.totalPrice.toLocaleString(\"en-US\", {\r\n                          maximumFractionDigits: 2,\r\n                          style: \"currency\",\r\n                          currency: \"USD\",\r\n                        })}\r\n                      </Col>\r\n                    </Row>\r\n                  </ListGroup.Item>\r\n                  {/* show paypal button or the stripe checkout form */}\r\n                  {!order.isPaid && (\r\n                    <>\r\n                      {order.paymentMethod === \"PayPal\" ? (\r\n                        <ListGroup.Item>\r\n                          {loadingPay && <Loader />}\r\n                          {!SDKReady ? (\r\n                            <Loader />\r\n                          ) : (\r\n                            <PayPalButton\r\n                              style={{\r\n                                shape: \"rect\",\r\n                                color: \"gold\",\r\n                                layout: \"vertical\",\r\n                                label: \"pay\",\r\n                              }}\r\n                              currency=\"USD\"\r\n                              amount={Number(order.totalPrice / 1).toFixed(2)}\r\n                              onSuccess={successPaymentHandler}\r\n                            />\r\n                          )}\r\n                        </ListGroup.Item>\r\n                      ) : (\r\n                        <ListGroup.Item>\r\n                          {loadingPay && <Loader />}\r\n                          <Elements stripe={stripePromise}>\r\n                            {/* price in paisa */}\r\n                            <CheckoutForm\r\n                              price={order.totalPrice * 100}\r\n                              orderID={orderID}\r\n                            />\r\n                          </Elements>\r\n                        </ListGroup.Item>\r\n                      )}\r\n                    </>\r\n                  )}\r\n                  {/* show this only to admins, after payment is done */}\r\n                  {userInfo &&\r\n                    userInfo.isAdmin &&\r\n                    order.isPaid &&\r\n                    !order.isDelivered && (\r\n                      <ListGroup.Item>\r\n                        {loadingDeliver && <Loader />}\r\n                        <div className=\"d-grid\">\r\n                          <Button\r\n                            type=\"button\"\r\n                            variant=\"info\"\r\n                            size=\"lg\"\r\n                            onClick={successDeliveryHandler}\r\n                          >\r\n                            Mark as Delivered\r\n                          </Button>\r\n                        </div>\r\n                      </ListGroup.Item>\r\n                    )}\r\n                </ListGroup>\r\n              </Card>\r\n            </Col>\r\n          </>\r\n        )}\r\n      </Row>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default OrderPage;\r\n"]},"metadata":{},"sourceType":"module"}